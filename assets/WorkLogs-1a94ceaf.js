import{y as Te,c as k,_ as _e,u as pe,s as ve,i as he,D as ye,a0 as Ke,a as be,r as y,w as Fe,o as we,X as De,b as n,d,l as i,h as t,W,x as j,I as q,e as v,v as x,F as le,f as ie,g as Z,B as ke,p as Se,k as Le,t as se,A as Me}from"./index-affc3919.js";import{_ as me,D as Ve}from"./DataPage-b21f61a6.js";import{T as Ae}from"./TabContainer-da289d4d.js";import{u as Ne}from"./input-4a95c407.js";import"./errors-ebd9927f.js";import"./DataForm-d1d7fb39.js";const{isEmpty:Ie,notEarlierThan:Be}=Te();function fe(){const p=[{key:"id",type:"text",label:"ID",listable:!0,viewable:!0,creatable:!1,updatable:!1,sortable:!0},{key:"startTime",type:"datetime",label:"Start Time",defaultValue:()=>new Date,listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0},{key:"endTime",type:"datetime",label:"End Time",listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0},{key:"description",type:"text",label:"Description",defaultValue:()=>"New Task",listable:!0,viewable:!0,creatable:!0,updatable:!0},{key:"content",type:"textarea",label:"Content",listable:!1,viewable:!0,creatable:!0,updatable:!0},{key:"tags",type:"multiSelect",label:"Tags",reference:{label:S},listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,options:{server:!0,pagination:!0,modelClass:"tags",value:X,label:S}}],C=[{startTime:"md",endTime:"md"},{description:"lg"},{content:"lg"},{tags:"lg"}],V={initData:{startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}},layout:[{tags:"md"},{startTime:"md"},{endTime:"md"}]},K={create:{endTime:[A]},update:{endTime:[A]}};function X(o){return o.id}function S(o){return`${o.category}:${o.name}`}function A(o){return Be(o,"endTime","startTime")}function N(o){if(o===0)return"0 h 0 m 0 s";const m=Math.floor(o/1e3/60/60/24),g=m*1e3*60*60*24,h=Math.floor((o-g)/1e3/60/60),$=h*1e3*60*60,b=Math.floor((o-g-$)/1e3/60),T=b*1e3*60,L=Math.floor((o-g-$-T)/1e3),u=[];return m>0&&u.push(`${m} d`),h>0&&u.push(`${h} h`),b>0&&u.push(`${b} m`),L>0&&u.push(`${L} s`),u.join(" ")}function I(o){return Ie(o.endTime)?new Date-new Date(o.startTime):new Date(o.endTime)-new Date(o.startTime)}const O=k(()=>p.filter(o=>o.reference)),f=k(()=>O.value.map(o=>o.key));return{dataFields:p,fieldsLayout:C,filters:V,validations:K,formatDuration:N,calculateDuration:I,includeKeys:f,recordValue:X,tagLabel:S}}const Oe=p=>(Se("data-v-b67ed403"),p=p(),Le(),p),Qe={class:"today-logs-container"},He={class:"controls"},Ue=["onKeydown"],je=["onKeydown"],qe=["onKeydown"],ze=["onKeydown"],Pe=["onKeydown"],Ge={class:"logs"},Xe={class:"total"},Ye=Oe(()=>i("div",{class:"divider"},null,-1)),Je={class:"duration"},Re={class:"start-time"},Ze={key:0,class:"end-time"},et={key:1,class:"elapsed"},tt={key:2,class:"elapsed"},at={class:"description"},st={__name:"TodayLog",setup(p){const{isEmpty:C,notEmpty:V}=Te(),K=pe(),S=ve().getSystemConfigs(),{formatShortTime:A}=ke(),{dataFields:N,fieldsLayout:I,validations:O,formatDuration:f,calculateDuration:o,includeKeys:m}=fe(),{formatDataFields:g,validateParams:h,formatDataForShow:$,formatDataForSave:b}=Ne(N),{flashMessage:T}=he(),L=ye(),u=Ke(),B=be(),_=y([]),z=k(()=>N.map(e=>e.key)),w=y({}),Y=k(()=>{const e=new Date;return e.setHours(0),e.setMinutes(0),e.setSeconds(0),e}),ee=k(()=>{const e=new Date;return e.setHours(23),e.setMinutes(59),e.setSeconds(59),e}),P=y([]),Q=k(()=>P.value.length===0?!1:C(w.value.endTime)&&l.value),oe=k(()=>P.value.reduce((e,r)=>e+r.duration,0));function ne(e){return e.map(r=>(r.duration=o(r),r))}function J(e){return C(e)?{}:(e.duration=o(e),e)}const D=y(!1),l=y(!1);function a(){return N.reduce((e,r)=>{const c=r.key,M=r.defaultValue;return V(M)?e[c]=M():e[c]=null,e},{})}function s(){w.value=a(),R.value="",D.value=!0}async function E(){w.value=a(),R.value="",await G(w.value)}function H(){D.value=!1}async function G(e){const r=h(O.create,e);if(Object.keys(r).length>0){T("Error submitting task!");return}const c=b(e);await K.create("work_logs",c).then(M=>{T("Started task successfully!"),re(),H()}).catch(M=>{B.error("Error creating data",M),T("Error creating data!")})}const U=y(!1),R=y(""),F=y({});Fe(U,(e,r)=>{e||(F.value={})});async function Ee(e){const r=h(O.update,e);if(Object.keys(r).length>0){T("Error submitting task!");return}const c=b(e);await K.update("work_logs",e.id,c).then(M=>{T("Ended task successfully!"),re(),We(),R.value==="quick"?E():R.value==="input"&&setTimeout(s,1e3)}).catch(M=>{B.error("Error submitting task",M),T("Error submitting task!")})}async function te(){F.value=Object.assign({},w.value),await $("startTime",F.value).then(e=>{F.value.startTime=e}),await $("tags",F.value).then(e=>{F.value.tags=e}),F.value.endTime=new Date,U.value=!0}function ue(){te(),R.value="input"}function de(){te(),R.value="quick"}function We(){F.value={},U.value=!1}const ce=y(!1),ae=k(()=>ce.value?"shortcut show":"shortcut hide");u.registerListener({route:"/work_logs",eventType:"ctrl-n"},{id:"TodayStartTask",invoke:e=>{s()}}),u.registerListener({route:"/work_logs",eventType:"ctrl-q"},{id:"TodayQuickStartTask",invoke:e=>{E()}}),u.registerListener({route:"/work_logs",eventType:"ctrl-e"},{id:"TodayEndTask",invoke:e=>{te()}}),u.registerListener({route:"/work_logs",eventType:"ctrl-g"},{id:"TodayEndTaskAndStartTask",invoke:e=>{ue()}}),u.registerListener({route:"/work_logs",eventType:"ctrl-f"},{id:"TodayEndTaskAndQuickStartTask",invoke:e=>{de()}}),u.registerListener({route:"/work_logs",eventType:"keydown-Escape"},{id:"CloseTodayLogDialogs",invoke:e=>{D.value&&(D.value=!1),U.value&&(U.value=!1)}});function xe(){u.unregisterListener({route:"/work_logs",eventType:"ctrl-n"},{id:"TodayStartTask"}),u.unregisterListener({route:"/work_logs",eventType:"ctrl-q"},{id:"TodayQuickStartTask"}),u.unregisterListener({route:"/work_logs",eventType:"ctrl-e"},{id:"TodayEndTask"}),u.unregisterListener({route:"/work_logs",eventType:"ctrl-g"},{id:"TodayEndTaskAndStartTask"}),u.unregisterListener({route:"/work_logs",eventType:"ctrl-f"},{id:"TodayEndTaskAndQuickStartTask"}),u.unregisterListener({route:"/work_logs",eventType:"keydown-Escape"},{id:"CloseTodayLogDialogs"})}L.registerListener("loadTodayLogs",{id:"TodayLog",invoke:e=>{re()}}),L.registerListener("toggleShortcut",{id:"ToggleTodayLogShortcut",invoke:e=>{ce.value=!ce.value}});function Ce(){L.unregisterListener("loadTodayLogs",{id:"TodayLog"}),L.unregisterListener("toggleShortcut",{id:"ToggleTodayLogShortcut"})}async function $e(){await K.schemas("work_logs").then(e=>{const r=e.fields;_.value=g(r)}).catch(e=>{T("Error loading schemas!"),B.error("Error loading schemas",e)})}async function re(){const e={include:m.value,filters:{startTime:{startDate:Y.value,endDate:ee.value}},sort:{field:"startTime",order:"desc"}};await K.list("work_logs",e).then(r=>{P.value=ne(r.data),w.value=J(P.value[0]),V(w.value.startTime)&&(l.value=!0)}).catch(r=>{T("Error loading work logs!"),B.error("Error loading work logs",r)})}return we(async()=>{await re(),await $e()}),De(()=>{Ce(),xe()}),(e,r)=>(n(),d("div",Qe,[i("div",He,[t(Q)?v("",!0):(n(),d("div",{key:0,class:"button",tabindex:"0",onClick:s,onKeydown:W(s,["enter"])},[j(" Start New Task "),i("div",{class:q(t(ae))}," N ",2)],40,Ue)),t(Q)?v("",!0):(n(),d("div",{key:1,class:"button",tabindex:"0",onClick:E,onKeydown:W(E,["enter"])},[j(" Quick Start New Task "),i("div",{class:q(t(ae))}," Q ",2)],40,je)),t(Q)?(n(),d("div",{key:2,class:"button",tabindex:"0",onClick:te,onKeydown:W(te,["enter"])},[j(" End Current Task "),i("div",{class:q(t(ae))}," E ",2)],40,qe)):v("",!0),t(Q)?(n(),d("div",{key:3,class:"button",tabindex:"0",onClick:ue,onKeydown:W(ue,["enter"])},[j(" End and Start New "),i("div",{class:q(t(ae))}," G ",2)],40,ze)):v("",!0),t(Q)?(n(),d("div",{key:4,class:"button",tabindex:"0",onClick:de,onKeydown:W(de,["enter"])},[j(" End and Quick Start "),i("div",{class:q(t(ae))}," F ",2)],40,Pe)):v("",!0)]),i("div",Ge,[i("div",Xe," Today's total: "+x(t(f)(t(oe))),1),(n(!0),d(le,null,ie(P.value,(c,M)=>(n(),d("div",{key:M,class:"log"},[Ye,i("div",Je,[i("div",Re,x(t(A)(c.startTime,t(S).timezone)),1),t(V)(c.endTime)?(n(),d("div",Ze," to "+x(t(A)(c.endTime,t(S).timezone)),1)):v("",!0),t(V)(c.endTime)?(n(),d("div",et," ("+x(t(f)(c.duration))+") ",1)):v("",!0),t(C)(c.endTime)?(n(),d("div",tt," (not ended) ")):v("",!0)]),i("div",at,x(c.description),1)]))),128))]),D.value?(n(),Z(me,{key:0,modelValue:D.value,"onUpdate:modelValue":r[0]||(r[0]=c=>D.value=c),data:w.value,"onUpdate:data":r[1]||(r[1]=c=>w.value=c),schemas:_.value,"fields-layout":t(I),"data-fields":t(z),fullscreen:!0,"dialog-title":"Start Task",onSubmit:G},null,8,["modelValue","data","schemas","fields-layout","data-fields"])):v("",!0),U.value?(n(),Z(me,{key:1,modelValue:U.value,"onUpdate:modelValue":r[2]||(r[2]=c=>U.value=c),data:F.value,"onUpdate:data":r[3]||(r[3]=c=>F.value=c),schemas:_.value,"fields-layout":t(I),"data-fields":t(z),fullscreen:!0,"dialog-title":"End Task",onSubmit:Ee},null,8,["modelValue","data","schemas","fields-layout","data-fields"])):v("",!0)]))}},ot=_e(st,[["__scopeId","data-v-b67ed403"]]);const ge=p=>(Se("data-v-779c309f"),p=p(),Le(),p),nt={class:"weekly-tab-container"},rt={class:"weekly-tabs"},lt=["onKeydown"],it=ge(()=>i("i",{class:"fa-solid fa-angle-left"},null,-1)),ut=["onKeydown"],dt=["onKeydown"],ct=ge(()=>i("i",{class:"fa-solid fa-angle-right"},null,-1)),vt={class:"weekly-tab-content"},yt={key:0,class:"total"},kt={key:1,class:"total"},ft={class:"timeline"},gt=ge(()=>i("div",{class:"divider"},null,-1)),mt={class:"heading"},Tt={class:"date"},_t={key:0,class:"duration"},pt={key:1,class:"duration"},ht={class:"entries"},bt={key:0},wt={class:"description"},Dt={class:"duration"},St={__name:"WeekLog",props:{loadData:{type:Boolean,default:!1}},setup(p){const C=pe(),K=ve().getSystemConfigs(),{formatLongDate:X}=ke(),{formatDuration:S,calculateDuration:A}=fe(),{flashMessage:N}=he(),I=ye(),O=be(),f=y("this"),o=y({}),m=y(0),g=y("prevWeekTab"),h=y("thisWeekTab"),$=y("nextWeekTab"),b=k(()=>{const l=new Date,a=new Date,s=m.value*7;return f.value==="prev"?(a.setDate(a.getDate()+s),a.setDate(a.getDate()-l.getDay())):(f.value==="next"&&a.setDate(a.getDate()+s),a.setDate(a.getDate()-l.getDay())),a.setHours(0),a.setMinutes(0),a.setSeconds(0),a}),T=k(()=>{const l=new Date;return l.setDate(b.value.getDate()+6),l.setHours(23),l.setMinutes(59),l.setSeconds(59),l}),L=k(()=>Array.from(Array(7)).map((l,a)=>{const s=new Date(b.value);return s.setDate(b.value.getDate()+a),s.setHours(0),s.setMinutes(0),s.setSeconds(0),s})),u=k(()=>({startTime:{startDate:b.value,endDate:T.value}})),B=k(()=>Object.entries(o.value).reduce((l,[a,{total:s}])=>l+s,0));function _(l){return o.value[l]?o.value[l]:{total:0,entries:[]}}function z(l){const a=L.value.reduce((s,E)=>(s[E]={entries:[],total:0},s),{});return l.forEach(s=>{const E=new Date(s.startTime),H=new Date(E.getFullYear(),E.getMonth(),E.getDate(),0,0,0),G=A(s);a[H].entries.push(Object.assign({},s,{duration:G})),a[H].total=a[H].total+G}),a}I.registerListener("loadWeeklyLogs",{id:"WeekLog",invoke:l=>{D()}});function w(){I.unregisterListener("loadWeeklyLogs",{id:"WeekLog"})}const Y=k(()=>f.value==="prev"?"weekly-tab active":"weekly-tab"),ee=k(()=>f.value==="this"?"weekly-tab active":"weekly-tab"),P=k(()=>f.value==="next"?"weekly-tab active":"weekly-tab");async function Q(){m.value=m.value-1,f.value="prev",g.value.blur(),await D()}async function oe(){m.value=0,f.value="this",h.value.blur(),await D()}async function ne(){m.value=m.value+1,f.value="next",$.value.blur(),await D()}function J(l){l==="prev"?g.value.focus():l==="next"?$.value.focus():h.value.focus()}async function D(){const l={filters:u.value};await C.list("work_logs",l).then(a=>{o.value=z(a.data)}).catch(a=>{N("Error loading work logs!"),O.error("Error loading work logs",a)})}return we(async()=>{await D()}),De(()=>{w()}),(l,a)=>(n(),d("div",nt,[i("div",rt,[i("div",{ref_key:"prevWeekTab",ref:g,class:q(t(Y)),tabindex:"0",onClick:Q,onKeydown:[W(Q,["enter"]),a[0]||(a[0]=W(s=>J("this"),["arrow-right"]))]},[it,j(" Prev Week ")],42,lt),i("div",{ref_key:"thisWeekTab",ref:h,class:q(t(ee)),tabindex:"0",onClick:oe,onKeydown:[W(oe,["enter"]),a[1]||(a[1]=W(s=>J("prev"),["arrow-left"])),a[2]||(a[2]=W(s=>J("next"),["arrow-right"]))]}," This Week ",42,ut),i("div",{ref_key:"nextWeekTab",ref:$,class:q(t(P)),tabindex:"0",onClick:ne,onKeydown:[W(ne,["enter"]),a[3]||(a[3]=W(s=>J("this"),["arrow-left"]))]},[j(" Next Week "),ct],42,dt)]),i("div",vt,[t(B)>0?(n(),d("div",yt," Week's total: "+x(t(S)(t(B))),1)):v("",!0),t(B)===0?(n(),d("div",kt," Week's total: 0 h 0 m 0 s ")):v("",!0),i("div",ft,[(n(!0),d(le,null,ie(t(L),(s,E)=>(n(),d("div",{key:E,class:"day"},[gt,i("div",mt,[i("div",Tt,x(t(X)(s,t(K).timezone)),1),_(s).total>0?(n(),d("div",_t," ("+x(t(S)(_(s).total))+") ",1)):v("",!0),_(s).total===0?(n(),d("div",pt," (0 h 0 m 0 s) ")):v("",!0)]),i("div",ht,[_(s).entries.length===0?(n(),d("div",bt," No entry ")):v("",!0),(n(!0),d(le,null,ie(_(s).entries,(H,G)=>(n(),d("div",{key:G,class:"entry"},[i("div",wt,x(H.description),1),i("div",Dt,x(t(S)(H.duration)),1)]))),128))])]))),128))])])]))}},Lt=_e(St,[["__scopeId","data-v-779c309f"]]),Ft={__name:"WorkLogs",setup(p){const C=ye(),{formatTagSync:V,tagStyle:K}=ke(),S=ve().getSystemConfigs(),{dataFields:A,fieldsLayout:N,filters:I,validations:O,formatDuration:f,calculateDuration:o}=fe(),m={oneline:!0,showHeader:!1,highlightField:"description"},g=y(0),h=[{label:"Today",onchange:$},{label:"Weekly",onchange:b},{label:"All Logs",onchange:T}];function $(){C.emitEvent("loadTodayLogs",{})}function b(){C.emitEvent("loadWeeklyLogs",{})}function T(){C.emitEvent("loadData",{dataType:"Work Logs"})}async function L(u){await h[u].onchange(),g.value=u}return(u,B)=>(n(),Z(Ae,{tabs:h,"selected-tab":g.value,onTabChange:L},{"tab-0":se(()=>[g.value===0?(n(),Z(ot,{key:0})):v("",!0)]),"tab-1":se(()=>[g.value===1?(n(),Z(Lt,{key:0})):v("",!0)]),"tab-2":se(()=>[g.value===2?(n(),Z(Ve,{key:0,"model-class":"work_logs","data-type":"Work Logs",fullscreen:!0,"fields-layout":t(N),"data-fields":t(A),validations:t(O),filters:t(I),"table-style":m},{["data-col.startTime"]:se(({row:_})=>[j(" Total duration "),i("strong",null,x(t(f)(t(o)(_))),1)]),["data-col.tags"]:se(({row:_,key:z,rawValue:w})=>[(n(!0),d(le,null,ie(w,(Y,ee)=>(n(),d("span",{key:ee,class:"tag inline",style:Me(t(K)(_,Y,z))},x(t(V)(_,Y,z,t(S).tagFormat)),5))),128))]),_:2},1032,["fields-layout","data-fields","validations","filters"])):v("",!0)]),_:1},8,["selected-tab"]))}};export{Ft as default};
