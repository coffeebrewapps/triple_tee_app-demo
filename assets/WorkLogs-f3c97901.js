import{B as Te,c as f,_ as _e,u as pe,v as ve,j as he,a as ye,a0 as Ke,k as we,r as y,w as Ve,o as be,b as De,d as n,e as d,n as l,i as t,X as x,A as H,J as q,f as v,y as C,F as le,g as ie,q as Fe,h as ae,E as fe,p as Se,m as Le,x as te,D as Me}from"./index-ba169bee.js";import{_ as me,D as Ae}from"./DataPage-591ce55a.js";import{T as Ne}from"./TabContainer-36089c86.js";import{u as Ie}from"./input-4371380f.js";import"./errors-ebd9927f.js";import"./DataForm-0ca6d382.js";const{isEmpty:Be,notEarlierThan:Oe}=Te();function ke(){const p=[{key:"id",type:"text",label:"ID",listable:!0,viewable:!0,creatable:!1,updatable:!1,sortable:!0},{key:"startTime",type:"datetime",label:"Start Time",defaultValue:()=>new Date,listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0},{key:"endTime",type:"datetime",label:"End Time",listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0},{key:"description",type:"text",label:"Description",defaultValue:()=>"New Task",listable:!0,viewable:!0,creatable:!0,updatable:!0},{key:"content",type:"textarea",label:"Content",listable:!1,viewable:!0,creatable:!0,updatable:!0},{key:"tags",type:"multiSelect",label:"Tags",reference:{label:D},listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,options:{server:!0,pagination:!0,modelClass:"tags",value:G,label:D}}],$=[{startTime:"md",endTime:"md"},{description:"lg"},{content:"lg"},{tags:"lg"}],F={initData:{startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}},layout:[{tags:"md"},{startTime:"md"},{endTime:"md"}]},V={create:{endTime:[M]},update:{endTime:[M]}};function G(o){return o.id}function D(o){return`${o.category}:${o.name}`}function M(o){return Oe(o,"endTime","startTime")}function A(o){if(o===0)return"0 h 0 m 0 s";const m=Math.floor(o/1e3/60/60/24),g=m*1e3*60*60*24,h=Math.floor((o-g)/1e3/60/60),K=h*1e3*60*60,w=Math.floor((o-g-K)/1e3/60),T=w*1e3*60,S=Math.floor((o-g-K-T)/1e3),i=[];return m>0&&i.push(`${m} d`),h>0&&i.push(`${h} h`),w>0&&i.push(`${w} m`),S>0&&i.push(`${S} s`),i.join(" ")}function N(o){return Be(o.endTime)?new Date-new Date(o.startTime):new Date(o.endTime)-new Date(o.startTime)}const B=f(()=>p.filter(o=>o.reference)),k=f(()=>B.value.map(o=>o.key));return{dataFields:p,fieldsLayout:$,filters:F,validations:V,formatDuration:A,calculateDuration:N,includeKeys:k,recordValue:G,tagLabel:D}}const Qe=p=>(Se("data-v-78dac82c"),p=p(),Le(),p),je={class:"today-logs-container"},He={class:"controls"},qe=["onKeydown"],ze=["onKeydown"],Ue=["onKeydown"],Pe=["onKeydown"],Ge=["onKeydown"],Je={class:"logs"},Xe={class:"total"},Ye=Qe(()=>l("div",{class:"divider"},null,-1)),Re={class:"duration"},Ze={class:"start-time"},et={key:0,class:"end-time"},tt={key:1,class:"elapsed"},at={key:2,class:"elapsed"},st={class:"description"},ot={__name:"TodayLog",setup(p){const{isEmpty:$,notEmpty:F}=Te(),V=pe(),D=ve().getSystemConfigs(),{formatShortTime:M}=fe(),{dataFields:A,fieldsLayout:N,validations:B,formatDuration:k,calculateDuration:o,includeKeys:m}=ke(),{formatDataFields:g,validateParams:h,formatDataForShow:K,formatDataForSave:w}=Ie(A),{flashMessage:T}=he(),S=ye(),i=Ke(),I=we(),_=y([]),z=f(()=>A.map(e=>e.key)),b=y({}),J=f(()=>{const e=new Date;return e.setHours(0),e.setMinutes(0),e.setSeconds(0),e}),R=f(()=>{const e=new Date;return e.setHours(23),e.setMinutes(59),e.setSeconds(59),e}),U=y([]),O=f(()=>U.value.length===0?!1:$(b.value.endTime)&&r.value),se=f(()=>U.value.reduce((e,u)=>e+u.duration,0));function oe(e){return e.map(u=>(u.duration=o(u),u))}function X(e){return $(e)?{}:(e.duration=o(e),e)}const L=y(!1),r=y(!1);function a(){return A.reduce((e,u)=>{const c=u.key,re=u.defaultValue;return F(re)?e[c]=re():e[c]=null,e},{})}function s(){b.value=a(),Y.value="",L.value=!0}async function E(){b.value=a(),Y.value="",await P()}function Q(){L.value=!1}async function P(){const e=h(B.create,b.value);if(Object.keys(e).length>0){T("Error submitting task!");return}const u=w(b.value);await V.create("work_logs",u).then(c=>{T("Started task successfully!"),ne(),Q()}).catch(c=>{I.error("Error creating data",c),T("Error creating data!")})}const j=y(!1),Y=y(""),W=y({});Ve(j,(e,u)=>{e||(W.value={})});async function Ee(){const e=h(B.update,W.value);if(Object.keys(e).length>0){T("Error submitting task!");return}const u=w(W.value);await V.update("work_logs",W.value.id,u).then(c=>{T("Ended task successfully!"),ne(),We(),Y.value==="quick"?E():Y.value==="input"&&setTimeout(s,1e3)}).catch(c=>{I.error("Error submitting task",c),T("Error submitting task!")})}async function Z(){W.value=Object.assign({},b.value),await K("startTime",W.value).then(e=>{W.value.startTime=e}),await K("tags",W.value).then(e=>{W.value.tags=e}),W.value.endTime=new Date,j.value=!0}function ue(){Z(),Y.value="input"}function de(){Z(),Y.value="quick"}function We(){W.value={},j.value=!1}const ce=y(!1),ee=f(()=>ce.value?"shortcut show":"shortcut hide");i.registerListener({route:"/work_logs",eventType:"ctrl-n"},{id:"TodayStartTask",invoke:e=>{s()}}),i.registerListener({route:"/work_logs",eventType:"ctrl-q"},{id:"TodayQuickStartTask",invoke:e=>{E()}}),i.registerListener({route:"/work_logs",eventType:"ctrl-e"},{id:"TodayEndTask",invoke:e=>{Z()}}),i.registerListener({route:"/work_logs",eventType:"ctrl-g"},{id:"TodayEndTaskAndStartTask",invoke:e=>{ue()}}),i.registerListener({route:"/work_logs",eventType:"ctrl-f"},{id:"TodayEndTaskAndQuickStartTask",invoke:e=>{de()}}),i.registerListener({route:"/work_logs",eventType:"keydown-Escape"},{id:"CloseTodayLogDialogs",invoke:e=>{L.value&&(L.value=!1),j.value&&(j.value=!1)}});function xe(){i.unregisterListener({route:"/work_logs",eventType:"ctrl-n"},{id:"TodayStartTask"}),i.unregisterListener({route:"/work_logs",eventType:"ctrl-q"},{id:"TodayQuickStartTask"}),i.unregisterListener({route:"/work_logs",eventType:"ctrl-e"},{id:"TodayEndTask"}),i.unregisterListener({route:"/work_logs",eventType:"ctrl-g"},{id:"TodayEndTaskAndStartTask"}),i.unregisterListener({route:"/work_logs",eventType:"ctrl-f"},{id:"TodayEndTaskAndQuickStartTask"}),i.unregisterListener({route:"/work_logs",eventType:"keydown-Escape"},{id:"CloseTodayLogDialogs"})}S.registerListener("loadTodayLogs",{id:"TodayLog",invoke:e=>{ne()}}),S.registerListener("toggleShortcut",{id:"ToggleTodayLogShortcut",invoke:e=>{ce.value=!ce.value}});function Ce(){S.unregisterListener("loadTodayLogs",{id:"TodayLog"}),S.unregisterListener("toggleShortcut",{id:"ToggleTodayLogShortcut"})}async function $e(){await V.schemas("work_logs").then(e=>{const u=e.fields;_.value=g(u)}).catch(e=>{T("Error loading schemas!"),I.error("Error loading schemas",e)})}async function ne(){const e={include:m.value,filters:{startTime:{startDate:J.value,endDate:R.value}},sort:{field:"startTime",order:"desc"}};await V.list("work_logs",e).then(u=>{U.value=oe(u.data),b.value=X(U.value[0]),F(b.value.startTime)&&(r.value=!0)}).catch(u=>{T("Error loading work logs!"),I.error("Error loading work logs",u)})}return be(async()=>{await ne(),await $e()}),De(()=>{Ce(),xe()}),(e,u)=>(n(),d("div",je,[l("div",He,[t(O)?v("",!0):(n(),d("div",{key:0,class:"button",tabindex:"0",onClick:s,onKeydown:x(s,["enter"])},[H(" Start New Task "),l("div",{class:q(t(ee))}," N ",2)],40,qe)),t(O)?v("",!0):(n(),d("div",{key:1,class:"button",tabindex:"0",onClick:E,onKeydown:x(E,["enter"])},[H(" Quick Start New Task "),l("div",{class:q(t(ee))}," Q ",2)],40,ze)),t(O)?(n(),d("div",{key:2,class:"button",tabindex:"0",onClick:Z,onKeydown:x(Z,["enter"])},[H(" End Current Task "),l("div",{class:q(t(ee))}," E ",2)],40,Ue)):v("",!0),t(O)?(n(),d("div",{key:3,class:"button",tabindex:"0",onClick:ue,onKeydown:x(ue,["enter"])},[H(" End and Start New "),l("div",{class:q(t(ee))}," G ",2)],40,Pe)):v("",!0),t(O)?(n(),d("div",{key:4,class:"button",tabindex:"0",onClick:de,onKeydown:x(de,["enter"])},[H(" End and Quick Start "),l("div",{class:q(t(ee))}," F ",2)],40,Ge)):v("",!0)]),l("div",Je,[l("div",Xe," Today's total: "+C(t(k)(t(se))),1),(n(!0),d(le,null,ie(U.value,(c,re)=>(n(),d("div",{key:re,class:"log"},[Ye,l("div",Re,[l("div",Ze,C(t(M)(c.startTime,t(D).timezone)),1),t(F)(c.endTime)?(n(),d("div",et," to "+C(t(M)(c.endTime,t(D).timezone)),1)):v("",!0),t(F)(c.endTime)?(n(),d("div",tt," ("+C(t(k)(c.duration))+") ",1)):v("",!0),t($)(c.endTime)?(n(),d("div",at," (not ended) ")):v("",!0)]),l("div",st,C(c.description),1)]))),128))]),Fe(me,{modelValue:L.value,"onUpdate:modelValue":u[0]||(u[0]=c=>L.value=c),schemas:_.value,"fields-layout":t(N),"data-fields":t(z),data:b.value,fullscreen:!0,"dialog-title":"Start Task",onSubmit:P},null,8,["modelValue","schemas","fields-layout","data-fields","data"]),j.value?(n(),ae(me,{key:0,modelValue:j.value,"onUpdate:modelValue":u[1]||(u[1]=c=>j.value=c),schemas:_.value,"fields-layout":t(N),"data-fields":t(z),data:W.value,fullscreen:!0,"dialog-title":"End Task",onSubmit:Ee},null,8,["modelValue","schemas","fields-layout","data-fields","data"])):v("",!0)]))}},nt=_e(ot,[["__scopeId","data-v-78dac82c"]]);const ge=p=>(Se("data-v-779c309f"),p=p(),Le(),p),rt={class:"weekly-tab-container"},lt={class:"weekly-tabs"},it=["onKeydown"],ut=ge(()=>l("i",{class:"fa-solid fa-angle-left"},null,-1)),dt=["onKeydown"],ct=["onKeydown"],vt=ge(()=>l("i",{class:"fa-solid fa-angle-right"},null,-1)),yt={class:"weekly-tab-content"},ft={key:0,class:"total"},kt={key:1,class:"total"},gt={class:"timeline"},mt=ge(()=>l("div",{class:"divider"},null,-1)),Tt={class:"heading"},_t={class:"date"},pt={key:0,class:"duration"},ht={key:1,class:"duration"},wt={class:"entries"},bt={key:0},Dt={class:"description"},St={class:"duration"},Lt={__name:"WeekLog",props:{loadData:{type:Boolean,default:!1}},setup(p){const $=pe(),V=ve().getSystemConfigs(),{formatLongDate:G}=fe(),{formatDuration:D,calculateDuration:M}=ke(),{flashMessage:A}=he(),N=ye(),B=we(),k=y("this"),o=y({}),m=y(0),g=y("prevWeekTab"),h=y("thisWeekTab"),K=y("nextWeekTab"),w=f(()=>{const r=new Date,a=new Date,s=m.value*7;return k.value==="prev"?(a.setDate(a.getDate()+s),a.setDate(a.getDate()-r.getDay())):(k.value==="next"&&a.setDate(a.getDate()+s),a.setDate(a.getDate()-r.getDay())),a.setHours(0),a.setMinutes(0),a.setSeconds(0),a}),T=f(()=>{const r=new Date;return r.setDate(w.value.getDate()+6),r.setHours(23),r.setMinutes(59),r.setSeconds(59),r}),S=f(()=>Array.from(Array(7)).map((r,a)=>{const s=new Date(w.value);return s.setDate(w.value.getDate()+a),s.setHours(0),s.setMinutes(0),s.setSeconds(0),s})),i=f(()=>({startTime:{startDate:w.value,endDate:T.value}})),I=f(()=>Object.entries(o.value).reduce((r,[a,{total:s}])=>r+s,0));function _(r){return o.value[r]?o.value[r]:{total:0,entries:[]}}function z(r){const a=S.value.reduce((s,E)=>(s[E]={entries:[],total:0},s),{});return r.forEach(s=>{const E=new Date(s.startTime),Q=new Date(E.getFullYear(),E.getMonth(),E.getDate(),0,0,0),P=M(s);a[Q].entries.push(Object.assign({},s,{duration:P})),a[Q].total=a[Q].total+P}),a}N.registerListener("loadWeeklyLogs",{id:"WeekLog",invoke:r=>{L()}});function b(){N.unregisterListener("loadWeeklyLogs",{id:"WeekLog"})}const J=f(()=>k.value==="prev"?"weekly-tab active":"weekly-tab"),R=f(()=>k.value==="this"?"weekly-tab active":"weekly-tab"),U=f(()=>k.value==="next"?"weekly-tab active":"weekly-tab");async function O(){m.value=m.value-1,k.value="prev",g.value.blur(),await L()}async function se(){m.value=0,k.value="this",h.value.blur(),await L()}async function oe(){m.value=m.value+1,k.value="next",K.value.blur(),await L()}function X(r){r==="prev"?g.value.focus():r==="next"?K.value.focus():h.value.focus()}async function L(){const r={filters:i.value};await $.list("work_logs",r).then(a=>{o.value=z(a.data)}).catch(a=>{A("Error loading work logs!"),B.error("Error loading work logs",a)})}return be(async()=>{await L()}),De(()=>{b()}),(r,a)=>(n(),d("div",rt,[l("div",lt,[l("div",{ref_key:"prevWeekTab",ref:g,class:q(t(J)),tabindex:"0",onClick:O,onKeydown:[x(O,["enter"]),a[0]||(a[0]=x(s=>X("this"),["arrow-right"]))]},[ut,H(" Prev Week ")],42,it),l("div",{ref_key:"thisWeekTab",ref:h,class:q(t(R)),tabindex:"0",onClick:se,onKeydown:[x(se,["enter"]),a[1]||(a[1]=x(s=>X("prev"),["arrow-left"])),a[2]||(a[2]=x(s=>X("next"),["arrow-right"]))]}," This Week ",42,dt),l("div",{ref_key:"nextWeekTab",ref:K,class:q(t(U)),tabindex:"0",onClick:oe,onKeydown:[x(oe,["enter"]),a[3]||(a[3]=x(s=>X("this"),["arrow-left"]))]},[H(" Next Week "),vt],42,ct)]),l("div",yt,[t(I)>0?(n(),d("div",ft," Week's total: "+C(t(D)(t(I))),1)):v("",!0),t(I)===0?(n(),d("div",kt," Week's total: 0 h 0 m 0 s ")):v("",!0),l("div",gt,[(n(!0),d(le,null,ie(t(S),(s,E)=>(n(),d("div",{key:E,class:"day"},[mt,l("div",Tt,[l("div",_t,C(t(G)(s,t(V).timezone)),1),_(s).total>0?(n(),d("div",pt," ("+C(t(D)(_(s).total))+") ",1)):v("",!0),_(s).total===0?(n(),d("div",ht," (0 h 0 m 0 s) ")):v("",!0)]),l("div",wt,[_(s).entries.length===0?(n(),d("div",bt," No entry ")):v("",!0),(n(!0),d(le,null,ie(_(s).entries,(Q,P)=>(n(),d("div",{key:P,class:"entry"},[l("div",Dt,C(Q.description),1),l("div",St,C(t(D)(Q.duration)),1)]))),128))])]))),128))])])]))}},Et=_e(Lt,[["__scopeId","data-v-779c309f"]]),Ft={__name:"WorkLogs",setup(p){const $=ye(),{formatTagSync:F,tagStyle:V}=fe(),D=ve().getSystemConfigs(),{dataFields:M,fieldsLayout:A,filters:N,validations:B,formatDuration:k,calculateDuration:o}=ke(),m={oneline:!0,showHeader:!1,highlightField:"description"},g=y(0),h=[{label:"Today",onchange:K},{label:"Weekly",onchange:w},{label:"All Logs",onchange:T}];function K(){$.emitEvent("loadTodayLogs",{})}function w(){$.emitEvent("loadWeeklyLogs",{})}function T(){$.emitEvent("loadData",{dataType:"Work Logs"})}async function S(i){await h[i].onchange(),g.value=i}return(i,I)=>(n(),ae(Ne,{tabs:h,"selected-tab":g.value,onTabChange:S},{"tab-0":te(()=>[g.value===0?(n(),ae(nt,{key:0})):v("",!0)]),"tab-1":te(()=>[g.value===1?(n(),ae(Et,{key:0})):v("",!0)]),"tab-2":te(()=>[g.value===2?(n(),ae(Ae,{key:0,"model-class":"work_logs","data-type":"Work Logs",fullscreen:!0,"fields-layout":t(A),"data-fields":t(M),validations:t(B),filters:t(N),"table-style":m},{["data-col.startTime"]:te(({row:_})=>[H(" Total duration "),l("strong",null,C(t(k)(t(o)(_))),1)]),["data-col.tags"]:te(({row:_,key:z,rawValue:b})=>[(n(!0),d(le,null,ie(b,(J,R)=>(n(),d("span",{key:R,class:"tag inline",style:Me(t(V)(_,J,z))},C(t(F)(_,J,z,t(D).tagFormat)),5))),128))]),_:2},1032,["fields-layout","data-fields","validations","filters"])):v("",!0)]),_:1},8,["selected-tab"]))}};export{Ft as default};
