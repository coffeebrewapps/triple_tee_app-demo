import{_ as Ce,y as _e,u as he,j as Le,a as ke,r as o,c as u,o as Se,b as _,d as Fe,m as v,s as c,h as l,g as E,e as U,l as f,W as De,V as h,I as we,v as Te,t as Ee}from"./index-c1560e4c.js";import{u as x}from"./input-0aa0a466.js";import{u as Ue}from"./utils-1c343f25.js";import{W as xe}from"./WorkflowContainer-f232317a.js";import{D as R}from"./DataForm-5b933c52.js";import{T as Ne}from"./TemplateEditor-365acaf2.js";import"./errors-ebd9927f.js";import"./TabContainer-9436e036.js";const je={class:"page-container"},Ae={class:"invoice-lines-table"},Me={class:"data-col"},Oe={class:"data-col"},He={class:"data-col"},ze={class:"data-col"},Be={class:"data-col"},Pe={__name:"CreateInvoice",props:{contactId:{type:String,default:null}},setup(G){const L=G,{isEmpty:J,notEmpty:V}=_e(),N=he(),{flashMessage:g}=Le(),I=ke(),{generateDataFields:Q,recordValue:k,tagLabel:j,contactLabel:A,invoiceConfigLabel:M}=Ue(),y=o({tags:[],contactId:[],invoiceConfigId:[],startTime:{startTime:null,endTime:null}}),S=u(()=>[{key:"contactId",type:"singleSelect",label:"Contact",reference:{label:A},listable:!1,viewable:!0,creatable:!0,updatable:!0,options:{server:!0,pagination:!0,modelClass:"contacts",value:k,label:A}},{key:"invoiceConfigId",type:"singleSelect",label:"Invoice Config",reference:{label:M},listable:!1,viewable:!0,creatable:!0,updatable:!0,options:{server:!0,pagination:!0,modelClass:"invoice_configs",value:k,label:M}},{key:"tags",type:"multiSelect",label:"Tags",reference:{label:j},listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,options:{server:!0,pagination:!0,modelClass:"tags",value:k,label:j}},{key:"startTime",type:"datetimerange",label:"Start Time",defaultValue:()=>new Date,listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0}]),X=x(S.value),Y=u(()=>[{contactId:"lg",invoiceConfigId:"lg"},{tags:"lg"},{startTime:"md"}]),Z=u(()=>S.value.map(e=>e.key)),$=o({});function F(){i.value=null,r.value=[],b.value=null,P.value={}}async function ee(e){const a=z.value.map(t=>w.formatDataForShow(t,e));Promise.all(a).then(t=>{i.value={},z.value.forEach((n,s)=>{i.value[n]=t[s]}),i.value.totalAmount=B.value}).catch(t=>{g("Error generating invoice!"),I.error("Error generating invoice",t)})}async function te(e){await ee(Object.assign({},e.invoice)),r.value=e.invoiceLines.map(a=>ce(a)),W.value=Object.assign({},e.invoiceConfig),T.value=Object.assign({},e.invoiceNumberSequence),q.value=Object.assign({},e.billingContact),K.value=Object.assign({},e.currency),b.value=Object.assign({},e.invoiceTemplate)}async function ae(){F(),d.value=!0;const e=X.formatFiltersForLoad(y.value);N.create("invoices",e,{path:"preview_invoice"}).then(a=>{te(a),d.value=!1,C.value=1}).catch(a=>{I.error("Error previewing invoice",a),g("Error previewing invoice!")})}function ne(){F(),y.value={contactId:[],tags:[],invoiceConfigId:[],startTime:{startTime:null,endTime:null}},V(L.contactId)&&(y.value.contactId=[{value:L.contactId}])}const O=[{key:"description",type:"text",label:"Description",listable:!0,creatable:!0,updatable:!0},{key:"unitValue",type:"number",label:"Unit Value",listable:!0,creatable:!0,updatable:!0},{key:"unitCost",type:"number",label:"Unit Cost",listable:!0,creatable:!0,updatable:!0},{key:"unit",type:"enum",label:"Unit",listable:!0,creatable:!0,updatable:!0},{key:"subtotal",type:"number",label:"Subtotal",listable:!0,creatable:!0,updatable:!0}],le=x(O),r=o([]),oe=[{name:"Create",icon:"fa-solid fa-circle-plus fa-xl",click:async function(e){await re()}}],ie=[{name:"Calculate",icon:"fa-solid fa-calculator",click:async function(e,a){await H(e)}},{name:"Delete",icon:"fa-solid fa-trash-can",click:async function(e,a){await ue(a)}}],d=o(!1),se=u(()=>[{value:"hour",label:"Hour"},{value:"minute",label:"Minute"},{value:"count",label:"Count"},{value:"fixed",label:"Fixed"}]);function re(){d.value=!0,r.value.push({description:null,unitCost:null,unit:null,unitValue:null,subtotal:null}),d.value=!1}function ue(e){d.value=!0,r.value.splice(e,1),d.value=!1}function ce(e){const a={};return a.description=e.description,a.unit=e.unit,a.unitCost=m(e.unitCost),a.unitValue=m(e.unitValue),J(e.subtotal)?H(a):a.subtotal=m(e.subtotal),a}function m(e){return(e||0).toFixed(2)}function H(e){const a=e.unitCost,t=e.unitValue;V(a)&&V(t)?e.subtotal=m(parseFloat(a)*parseFloat(t)):e.subtotal=m(0),i.value.totalAmount=B.value}const de=o([]);function p(e,a){return de[e]?p[e][a]:""}const i=o(),ve=[{invoiceNumber:"lg",contactId:"lg"},{invoiceDate:"md",dueDate:"md",totalAmount:"md"},{customFields:"md"},{invoiceConfigId:"lg"},{currencyId:"lg"}],D=u(()=>Q(L.contactId)),z=u(()=>D.value.map(e=>e.key)),w=x(D.value),me=u(()=>w.updatableKeys.value),B=u(()=>{const e=r.value.reduce((a,t)=>V(t.subtotal)?a+parseFloat(t.subtotal):a,0);return m(e)}),P=o({}),b=o(),W=o(),T=o(),q=o(),K=o(),pe=u(()=>({invoice:i.value,invoiceLines:r.value,invoiceConfig:W.value,invoiceNumberSequence:T.value,billingContact:q.value,currency:K.value}));async function be(){return new Promise((e,a)=>{const t=r.value.map(n=>le.formatDataForSave(n));Promise.all(t).then(n=>{e(n)}).catch(n=>{a(n)})})}async function fe(){await be().then(e=>{const a=Object.assign({},{invoice:w.formatDataForSave(i.value),invoiceNumberSequence:T.value,invoiceLines:e});N.create("invoices",a,{path:"generate_with_lines"}).then(t=>{i.value.id=t.id,r.value=t.invoiceLines,C.value=2,g("Invoice created successfully!")}).catch(t=>{g("Error creating invoice!"),I.error("Error creating invoice",t)})}).catch(e=>{g("Error formatting invoice for save!"),I.error("Error formatting invoice for save",e)})}const C=o(0),ge=u(()=>[{title:"Filter Work Logs"},{title:"Fill Invoice and Lines"},{title:"Preview Invoice"}]);async function ye(e){e===0&&(F(),C.value=e)}async function Ve(e){e===1&&await ae()}async function Ie(){await fe()}return Se(()=>{ne()}),(e,a)=>(_(),Fe("div",je,[v(xe,{steps:l(ge),"current-step-number":C.value,onPrevStep:ye,onNextStep:Ve,onSubmit:Ie},{"step-0":c(()=>[v(R,{modelValue:y.value,"onUpdate:modelValue":a[0]||(a[0]=t=>y.value=t),"fields-layout":l(Y),"data-fields":l(Z),schemas:l(S),"error-messages":$.value,submittable:!1},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages"])]),"step-1":c(()=>[i.value?(_(),E(R,{key:0,modelValue:i.value,"onUpdate:modelValue":a[1]||(a[1]=t=>i.value=t),"fields-layout":ve,"data-fields":l(me),schemas:l(D),"error-messages":P.value,submittable:!1},null,8,["modelValue","data-fields","schemas","error-messages"])):U("",!0),f("div",Ae,[i.value?(_(),E(l(De),{key:0,name:"Invoice Lines",headers:O,data:r.value,"table-actions":oe,actions:ie,loading:d.value,pagination:{offset:0,limit:r.value.length,client:!0}},{["data-col.description"]:c(({row:t,i:n})=>[f("div",Me,[v(l(h),{modelValue:t.description,"onUpdate:modelValue":s=>t.description=s,type:"text",label:"",size:"md","error-message":p(n,"description")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),["data-col.unitCost"]:c(({row:t,i:n})=>[f("div",Oe,[v(l(h),{modelValue:t.unitCost,"onUpdate:modelValue":s=>t.unitCost=s,type:"number",label:"",size:"sm","error-message":p(n,"unitCost")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),["data-col.unit"]:c(({row:t,i:n})=>[f("div",He,[v(l(we),{modelValue:t.unit,"onUpdate:modelValue":s=>t.unit=s,type:"text",label:"",size:"sm",options:l(se),"error-message":p(n,"unit")},null,8,["modelValue","onUpdate:modelValue","options","error-message"])])]),["data-col.unitValue"]:c(({row:t,i:n})=>[f("div",ze,[v(l(h),{modelValue:t.unitValue,"onUpdate:modelValue":s=>t.unitValue=s,type:"number",label:"",size:"sm","error-message":p(n,"unitValue")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),["data-col.subtotal"]:c(({row:t,i:n})=>[f("div",Be,[v(l(h),{modelValue:t.subtotal,"onUpdate:modelValue":s=>t.subtotal=s,type:"number",label:"",size:"sm","error-message":p(n,"subtotal")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),pagination:c(({total:t})=>[Te(" Total Lines: "+Ee(t),1)]),_:2},1032,["data","loading","pagination"])):U("",!0)])]),"step-2":c(()=>[b.value?(_(),E(Ne,{key:0,id:b.value.id,"template-type":"invoice_templates","content-markup":b.value.contentMarkup,"content-styles":b.value.contentStyles,data:l(pe),disabled:!0},null,8,["id","content-markup","content-styles","data"])):U("",!0)]),_:1},8,["steps","current-step-number"])]))}},Ye=Ce(Pe,[["__scopeId","data-v-718d2e50"]]);export{Ye as default};
