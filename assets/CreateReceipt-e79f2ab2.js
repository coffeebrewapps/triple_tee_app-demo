import{_ as de,A as fe,u as ge,i as be,j as ye,r as a,c as i,w as _e,o as he,b as E,d as Ie,n as P,v as D,h as s,g as T,e as U,D as Se,p as Ce,l as Ae,m as Re}from"./index-cb685be9.js";import{u as H}from"./input-8a5f7417.js";import{u as ke}from"./utils-a68ebf58.js";import{W as Fe}from"./WorkflowContainer-b60c0af1.js";import{D as K}from"./DataForm-c53d97cb.js";import{T as we}from"./TemplateEditor-b8b3fb65.js";import"./errors-ebd9927f.js";import"./TabContainer-d2be7745.js";const Ee=c=>(Ce("data-v-3fc72d84"),c=c(),Ae(),c),De={class:"page-container"},je=Ee(()=>Re("h3",{class:"heading"}," Create Receipt ",-1)),Ne={__name:"CreateReceipt",props:{contactId:{type:String,default:null},invoiceId:{type:String,default:null}},setup(c){const u=c,{isEmpty:j,notEmpty:W}=fe(),N=ge(),{formatNumber:z}=Se(),{flashMessage:p}=be(),g=ye(),{fieldsLayout:G,generateDataFields:J,recordValue:O,receiptConfigLabel:V,invoiceLabel:x,validations:Q}=ke(),l=a({invoiceId:[],receiptConfigId:[]});W(u.invoiceId)&&(l.value.invoiceId=[{value:u.invoiceId}]);const b=i(()=>[{key:"invoiceId",type:"singleSelect",label:"Invoice",reference:{label:x},listable:!1,viewable:!0,creatable:!0,updatable:!0,options:{server:!0,pagination:!0,modelClass:"invoices",value:O,label:x}},{key:"receiptConfigId",type:"singleSelect",label:"Receipt Config",reference:{label:V},listable:!1,viewable:!0,creatable:!0,updatable:!0,options:{server:!0,pagination:!0,modelClass:"receipt_configs",value:O,label:V}}]),X=H(b.value),Y=i(()=>[{invoiceId:"lg",receiptConfigId:"lg"}]),Z=i(()=>b.value.map(e=>e.key)),$=a({});function y(){n.value=null,I.value=null,S.value=null,C.value=null,d.value=null,A.value=null,o.value=null,R.value=null,v.value={},_.value=0}async function ee(e){const t=q.value.map(r=>h.formatDataForShow(r,e));Promise.all(t).then(r=>{n.value={},q.value.forEach((F,w)=>{n.value[F]=r[w]})}).catch(r=>{p("Error generating receipt!"),g.error("Error generating receipt",r)})}async function te(e){await ee(Object.assign({},e.receipt)),I.value=Object.assign({},e.invoice),S.value=Object.assign({},e.currency),C.value=Object.assign({},e.billingContact),d.value=Object.assign({},e.receiptConfig),A.value=Object.assign({},e.receiptNumberSequence),o.value=Object.assign({},e.receiptTemplate),R.value=Object.assign({},e.invoiceNumberSequence)}async function ae(){y();const e=X.formatFilters(l.value);N.create("income_receipts",e,{path:"preview_receipt"}).then(t=>{te(t),f.value=1}).catch(t=>{g.error("Error previewing receipt",t),p("Error previewing receipt!")})}function ne(){y(),l.value={invoiceId:[],receiptConfigId:[]}}const n=a(),_=a(0),re=G,m=i(()=>J(u.invoiceId,u.contactId)),ie=i(()=>ce.value.map(e=>e.key)),se=["receiptNumber","billableAmount","paidAmount","remainingAmount"],ce=i(()=>m.value.filter(e=>!se.includes(e.key)&&e.creatable)),q=i(()=>m.value.map(e=>e.key)),h=H(m.value);_e(n,(e,t)=>{if(!(j(e)||j(t))&&(v.value={},_.value!==e.paymentAmount)){const{billableAmount:r,paidAmount:F,paymentAmount:w}=n.value,B=r-F-w,M=h.validateParams({remainingAmount:Q.create.remainingAmount},Object.assign({},n.value,{paymentAmount:e.paymentAmount,remainingAmount:B}));Object.keys(M).length>0?v.value=M:n.value.remainingAmount=parseFloat(z(B,2)),_.value=e.paymentAmount}},{deep:!0});const v=a({}),I=a(),S=a(),L=a(),C=a(),d=a(),A=a(),o=a(),R=a(),le=i(()=>({receipt:n.value,invoice:I.value,currency:S.value,transaction:L.value,billingContact:C.value,receiptConfig:d.value,receiptNumberSequence:A.value,invoiceNumberSequence:R.value})),k=a(!1);async function oe(){k.value=!1;const e=Object.assign({},{receipt:h.formatDataForSave(n.value),incomeReceiptConfigId:d.value.id});await N.create("income_receipts",e,{path:"generate_with_transaction"}).then(t=>{n.value.id=t.id,L.value=t.transaction,k.value=!0,f.value=2,p("Receipt created successfully!")}).catch(t=>{p("Error creating receipt!"),g.error("Error creating receipt",t)})}const f=a(0),ue=i(()=>[{title:"Select Invoice"},{title:"Fill Receipt"},{title:"Preview Receipt"}]);async function pe(e){e===0&&(y(),f.value=e)}async function me(e){e===1&&await ae()}async function ve(){await oe()}return he(()=>{ne()}),(e,t)=>(E(),Ie("div",De,[je,P(Fe,{steps:s(ue),"current-step-number":f.value,onPrevStep:pe,onNextStep:me,onSubmit:ve},{"step-0":D(()=>[P(K,{modelValue:l.value,"onUpdate:modelValue":t[0]||(t[0]=r=>l.value=r),"fields-layout":s(Y),"data-fields":s(Z),schemas:s(b),"error-messages":$.value,submittable:!1},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages"])]),"step-1":D(()=>[n.value?(E(),T(K,{key:0,modelValue:n.value,"onUpdate:modelValue":t[1]||(t[1]=r=>n.value=r),"fields-layout":s(re),"data-fields":s(ie),schemas:s(m),"error-messages":v.value,submittable:!1},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages"])):U("",!0)]),"step-2":D(()=>[k.value?(E(),T(we,{key:0,id:o.value.id,"template-type":"receipt_templates","content-markup":o.value.contentMarkup,"content-styles":o.value.contentStyles,data:s(le),disabled:!0},null,8,["id","content-markup","content-styles","data"])):U("",!0)]),_:1},8,["steps","current-step-number"])]))}},Te=de(Ne,[["__scopeId","data-v-3fc72d84"]]);export{Te as default};
