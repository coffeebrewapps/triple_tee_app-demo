import{_ as Ce,v as _e,a as he,u as Le,b as ke,r as o,d as u,e as Te,o as _,c as Se,l as v,q as c,h as l,g as D,f as E,k as f,i as Fe,L as h,Y as we,s as De,t as Ee}from"./index-c658bd47.js";import{u as U}from"./input-0d8e93b0.js";import{u as Ue}from"./utils-87e74dec.js";import{W as xe}from"./WorkflowContainer-91f33918.js";import{D as R}from"./DataForm-115dae47.js";import{T as Ne}from"./TemplateEditor-5412f14b.js";import"./errors-29306128.js";import"./TabContainer-ad097b63.js";const Oe={class:"page-container"},je={class:"invoice-lines-table"},Ae={class:"data-col"},Me={class:"data-col"},He={class:"data-col"},qe={class:"data-col"},ze={class:"data-col"},Be={__name:"CreateInvoice",props:{contactId:{type:String,default:null}},setup(G){const L=G,{isEmpty:J,notEmpty:V}=_e(),x=he(),{flashMessage:g}=Le(),I=ke(),{generateDataFields:Q,recordValue:k,tagLabel:N,contactLabel:O,invoiceConfigLabel:j}=Ue(),y=o({tags:[],contactId:[],invoiceConfigId:[],startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}}),T=u(()=>[{key:"contactId",type:"singleSelect",label:"Contact",reference:{label:O},listable:!1,viewable:!0,creatable:!0,updatable:!0,options:{server:!0,pagination:!0,modelClass:"contacts",value:k,label:O}},{key:"invoiceConfigId",type:"singleSelect",label:"Invoice Config",reference:{label:j},listable:!1,viewable:!0,creatable:!0,updatable:!0,options:{server:!0,pagination:!0,modelClass:"invoice_configs",value:k,label:j}},{key:"tags",type:"multiSelect",label:"Tags",reference:{label:N},listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,options:{server:!0,pagination:!0,modelClass:"tags",value:k,label:N}},{key:"startTime",type:"datetimerange",label:"Start Time",defaultValue:()=>new Date,listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0},{key:"endTime",type:"datetimerange",label:"End Time",listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0}]),X=U(T.value),Z=u(()=>[{contactId:"lg",invoiceConfigId:"lg"},{tags:"lg"},{startTime:"md"},{endTime:"md"}]),$=u(()=>T.value.map(e=>e.key)),ee=o({});function S(){i.value=null,r.value=[],b.value=null,P.value={}}async function te(e){const a=q.value.map(t=>z.formatDataForShow(t,e));Promise.all(a).then(t=>{i.value={},q.value.forEach((n,s)=>{i.value[n]=t[s]}),i.value.totalAmount=B.value}).catch(t=>{g("Error generating invoice!"),I.error("Error generating invoice",t)})}async function ae(e){await te(Object.assign({},e.invoice)),r.value=e.invoiceLines.map(a=>de(a)),K.value=Object.assign({},e.invoiceConfig),w.value=Object.assign({},e.invoiceNumberSequence),W.value=Object.assign({},e.billingContact),Y.value=Object.assign({},e.currency),b.value=Object.assign({},e.invoiceTemplate)}async function ne(){S(),d.value=!0;const e=X.formatFilters(y.value);x.create("invoices",e,{path:"preview_invoice"}).then(a=>{ae(a),d.value=!1,C.value=1}).catch(a=>{I.error("Error previewing invoice",a),g("Error previewing invoice!")})}function le(){S(),y.value={contactId:[],tags:[],invoiceConfigId:[],startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}},V(L.contactId)&&(y.value.contactId=[{value:L.contactId}])}const A=[{key:"description",type:"text",label:"Description",listable:!0,creatable:!0,updatable:!0},{key:"unitValue",type:"number",label:"Unit Value",listable:!0,creatable:!0,updatable:!0},{key:"unitCost",type:"number",label:"Unit Cost",listable:!0,creatable:!0,updatable:!0},{key:"unit",type:"enum",label:"Unit",listable:!0,creatable:!0,updatable:!0},{key:"subtotal",type:"number",label:"Subtotal",listable:!0,creatable:!0,updatable:!0}],oe=U(A),r=o([]),ie=[{name:"Create",icon:"fa-solid fa-circle-plus fa-xl",click:async function(e){await ue()}}],se=[{name:"Calculate",icon:"fa-solid fa-calculator",click:async function(e,a){await M(e)}},{name:"Delete",icon:"fa-solid fa-trash-can",click:async function(e,a){await ce(a)}}],d=o(!1),re=u(()=>[{value:"hour",label:"Hour"},{value:"minute",label:"Minute"},{value:"count",label:"Count"},{value:"fixed",label:"Fixed"}]);function ue(){d.value=!0,r.value.push({description:null,unitCost:null,unit:null,unitValue:null,subtotal:null}),d.value=!1}function ce(e){d.value=!0,r.value.splice(e,1),d.value=!1}function de(e){const a={};return a.description=e.description,a.unit=e.unit,a.unitCost=m(e.unitCost),a.unitValue=m(e.unitValue),J(e.subtotal)?M(a):a.subtotal=m(e.subtotal),a}function m(e){return(e||0).toFixed(2)}function M(e){const a=e.unitCost,t=e.unitValue;V(a)&&V(t)?e.subtotal=m(parseFloat(a)*parseFloat(t)):e.subtotal=m(0),i.value.totalAmount=B.value}const ve=o([]);function p(e,a){return ve[e]?p[e][a]:""}const i=o(),H=[{invoiceNumber:"lg",contactId:"lg"},{invoiceDate:"md",dueDate:"md",totalAmount:"md"},{customFields:"md"},{invoiceConfigId:"lg"},{currencyId:"lg"}],me=u(()=>H.reduce((e,a)=>(Object.keys(a).forEach(t=>{e.push(t)}),e),[])),F=u(()=>Q(L.contactId)),q=u(()=>F.value.map(e=>e.key)),z=U(F.value),B=u(()=>{const e=r.value.reduce((a,t)=>V(t.subtotal)?a+parseFloat(t.subtotal):a,0);return m(e)}),P=o({}),b=o(),K=o(),w=o(),W=o(),Y=o(),pe=u(()=>({invoice:i.value,invoiceLines:r.value,invoiceConfig:K.value,invoiceNumberSequence:w.value,billingContact:W.value,currency:Y.value}));async function be(){return new Promise((e,a)=>{const t=r.value.map(n=>oe.formatDataForSave(n));Promise.all(t).then(n=>{e(n)}).catch(n=>{a(n)})})}async function fe(){await be().then(e=>{const a=Object.assign({},{invoice:z.formatDataForSave(i.value),invoiceNumberSequence:w.value,invoiceLines:e});x.create("invoices",a,{path:"generate_with_lines"}).then(t=>{i.value.id=t.id,r.value=t.invoiceLines,C.value=2,g("Invoice created successfully!")}).catch(t=>{g("Error creating invoice!"),I.error("Error creating invoice",t)})}).catch(e=>{g("Error formatting invoice for save!"),I.error("Error formatting invoice for save",e)})}const C=o(0),ge=u(()=>[{title:"Filter Work Logs"},{title:"Fill Invoice and Lines"},{title:"Preview Invoice"}]);async function ye(e){e===0&&(S(),C.value=e)}async function Ve(e){e===1&&await ne()}async function Ie(){await fe()}return Te(()=>{le()}),(e,a)=>(_(),Se("div",Oe,[v(xe,{steps:l(ge),"current-step-number":C.value,onPrevStep:ye,onNextStep:Ve,onSubmit:Ie},{"step-0":c(()=>[v(R,{modelValue:y.value,"onUpdate:modelValue":a[0]||(a[0]=t=>y.value=t),"fields-layout":l(Z),"data-fields":l($),schemas:l(T),"error-messages":ee.value,submittable:!1},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages"])]),"step-1":c(()=>[i.value?(_(),D(R,{key:0,modelValue:i.value,"onUpdate:modelValue":a[1]||(a[1]=t=>i.value=t),"fields-layout":H,"data-fields":l(me),schemas:l(F),"error-messages":P.value,submittable:!1},null,8,["modelValue","data-fields","schemas","error-messages"])):E("",!0),f("div",je,[i.value?(_(),D(l(Fe),{key:0,name:"Invoice Lines",headers:A,data:r.value,"table-actions":ie,actions:se,loading:d.value,pagination:{offset:0,limit:r.value.length,client:!0}},{["data-col.description"]:c(({row:t,i:n})=>[f("div",Ae,[v(l(h),{modelValue:t.description,"onUpdate:modelValue":s=>t.description=s,type:"text",label:"",size:"md","error-message":p(n,"description")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),["data-col.unitCost"]:c(({row:t,i:n})=>[f("div",Me,[v(l(h),{modelValue:t.unitCost,"onUpdate:modelValue":s=>t.unitCost=s,type:"number",label:"",size:"sm","error-message":p(n,"unitCost")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),["data-col.unit"]:c(({row:t,i:n})=>[f("div",He,[v(l(we),{modelValue:t.unit,"onUpdate:modelValue":s=>t.unit=s,type:"text",label:"",size:"sm",options:l(re),"error-message":p(n,"unit")},null,8,["modelValue","onUpdate:modelValue","options","error-message"])])]),["data-col.unitValue"]:c(({row:t,i:n})=>[f("div",qe,[v(l(h),{modelValue:t.unitValue,"onUpdate:modelValue":s=>t.unitValue=s,type:"number",label:"",size:"sm","error-message":p(n,"unitValue")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),["data-col.subtotal"]:c(({row:t,i:n})=>[f("div",ze,[v(l(h),{modelValue:t.subtotal,"onUpdate:modelValue":s=>t.subtotal=s,type:"number",label:"",size:"sm","error-message":p(n,"subtotal")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),pagination:c(({total:t})=>[De(" Total Lines: "+Ee(t),1)]),_:2},1032,["data","loading","pagination"])):E("",!0)])]),"step-2":c(()=>[b.value?(_(),D(Ne,{key:0,id:b.value.id,"template-type":"invoice_templates","content-markup":b.value.contentMarkup,"content-styles":b.value.contentStyles,data:l(pe),disabled:!0},null,8,["id","content-markup","content-styles","data"])):E("",!0)]),_:1},8,["steps","current-step-number"])]))}},Xe=Ce(Be,[["__scopeId","data-v-da65e948"]]);export{Xe as default};
