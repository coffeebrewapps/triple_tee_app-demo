import{_ as Ce,z as _e,u as he,i as Le,j as ke,r as o,c as u,o as Te,b as _,d as Se,n as v,v as c,h as l,g as F,e as D,m as f,k as we,E as h,$ as Ee,y as Fe,x as De}from"./index-9e5b3068.js";import{u as U}from"./input-188c93b4.js";import{u as Ue}from"./utils-7bc63dc3.js";import{W as xe}from"./WorkflowContainer-df4232ec.js";import{D as R}from"./DataForm-41511fb8.js";import{T as Ne}from"./TemplateEditor-2c9471c9.js";import"./errors-ebd9927f.js";import"./TabContainer-41739278.js";const je={class:"page-container"},Oe={class:"invoice-lines-table"},Ae={class:"data-col"},Me={class:"data-col"},ze={class:"data-col"},He={class:"data-col"},Be={class:"data-col"},Pe={__name:"CreateInvoice",props:{contactId:{type:String,default:null}},setup(G){const L=G,{isEmpty:J,notEmpty:V}=_e(),x=he(),{flashMessage:g}=Le(),I=ke(),{generateDataFields:Q,recordValue:k,tagLabel:N,contactLabel:j,invoiceConfigLabel:O}=Ue(),y=o({tags:[],contactId:[],invoiceConfigId:[],startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}}),T=u(()=>[{key:"contactId",type:"singleSelect",label:"Contact",reference:{label:j},listable:!1,viewable:!0,creatable:!0,updatable:!0,options:{server:!0,pagination:!0,modelClass:"contacts",value:k,label:j}},{key:"invoiceConfigId",type:"singleSelect",label:"Invoice Config",reference:{label:O},listable:!1,viewable:!0,creatable:!0,updatable:!0,options:{server:!0,pagination:!0,modelClass:"invoice_configs",value:k,label:O}},{key:"tags",type:"multiSelect",label:"Tags",reference:{label:N},listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,options:{server:!0,pagination:!0,modelClass:"tags",value:k,label:N}},{key:"startTime",type:"datetimerange",label:"Start Time",defaultValue:()=>new Date,listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0},{key:"endTime",type:"datetimerange",label:"End Time",listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0}]),X=U(T.value),Y=u(()=>[{contactId:"lg",invoiceConfigId:"lg"},{tags:"lg"},{startTime:"md"},{endTime:"md"}]),Z=u(()=>T.value.map(e=>e.key)),ee=o({});function S(){i.value=null,r.value=[],b.value=null,q.value={}}async function te(e){const a=H.value.map(t=>B.formatDataForShow(t,e));Promise.all(a).then(t=>{i.value={},H.value.forEach((n,s)=>{i.value[n]=t[s]}),i.value.totalAmount=P.value}).catch(t=>{g("Error generating invoice!"),I.error("Error generating invoice",t)})}async function ae(e){await te(Object.assign({},e.invoice)),r.value=e.invoiceLines.map(a=>de(a)),K.value=Object.assign({},e.invoiceConfig),E.value=Object.assign({},e.invoiceNumberSequence),W.value=Object.assign({},e.billingContact),$.value=Object.assign({},e.currency),b.value=Object.assign({},e.invoiceTemplate)}async function ne(){S(),d.value=!0;const e=X.formatFilters(y.value);x.create("invoices",e,{path:"preview_invoice"}).then(a=>{ae(a),d.value=!1,C.value=1}).catch(a=>{I.error("Error previewing invoice",a),g("Error previewing invoice!")})}function le(){S(),y.value={contactId:[],tags:[],invoiceConfigId:[],startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}},V(L.contactId)&&(y.value.contactId=[{value:L.contactId}])}const A=[{key:"description",type:"text",label:"Description",listable:!0,creatable:!0,updatable:!0},{key:"unitValue",type:"number",label:"Unit Value",listable:!0,creatable:!0,updatable:!0},{key:"unitCost",type:"number",label:"Unit Cost",listable:!0,creatable:!0,updatable:!0},{key:"unit",type:"enum",label:"Unit",listable:!0,creatable:!0,updatable:!0},{key:"subtotal",type:"number",label:"Subtotal",listable:!0,creatable:!0,updatable:!0}],oe=U(A),r=o([]),ie=[{name:"Create",icon:"fa-solid fa-circle-plus fa-xl",click:async function(e){await ue()}}],se=[{name:"Calculate",icon:"fa-solid fa-calculator",click:async function(e,a){await M(e)}},{name:"Delete",icon:"fa-solid fa-trash-can",click:async function(e,a){await ce(a)}}],d=o(!1),re=u(()=>[{value:"hour",label:"Hour"},{value:"minute",label:"Minute"},{value:"count",label:"Count"},{value:"fixed",label:"Fixed"}]);function ue(){d.value=!0,r.value.push({description:null,unitCost:null,unit:null,unitValue:null,subtotal:null}),d.value=!1}function ce(e){d.value=!0,r.value.splice(e,1),d.value=!1}function de(e){const a={};return a.description=e.description,a.unit=e.unit,a.unitCost=m(e.unitCost),a.unitValue=m(e.unitValue),J(e.subtotal)?M(a):a.subtotal=m(e.subtotal),a}function m(e){return(e||0).toFixed(2)}function M(e){const a=e.unitCost,t=e.unitValue;V(a)&&V(t)?e.subtotal=m(parseFloat(a)*parseFloat(t)):e.subtotal=m(0),i.value.totalAmount=P.value}const ve=o([]);function p(e,a){return ve[e]?p[e][a]:""}const i=o(),z=[{invoiceNumber:"lg",contactId:"lg"},{invoiceDate:"md",dueDate:"md",totalAmount:"md"},{customFields:"md"},{invoiceConfigId:"lg"},{currencyId:"lg"}],me=u(()=>z.reduce((e,a)=>(Object.keys(a).forEach(t=>{e.push(t)}),e),[])),w=u(()=>Q(L.contactId)),H=u(()=>w.value.map(e=>e.key)),B=U(w.value),P=u(()=>{const e=r.value.reduce((a,t)=>V(t.subtotal)?a+parseFloat(t.subtotal):a,0);return m(e)}),q=o({}),b=o(),K=o(),E=o(),W=o(),$=o(),pe=u(()=>({invoice:i.value,invoiceLines:r.value,invoiceConfig:K.value,invoiceNumberSequence:E.value,billingContact:W.value,currency:$.value}));async function be(){return new Promise((e,a)=>{const t=r.value.map(n=>oe.formatDataForSave(n));Promise.all(t).then(n=>{e(n)}).catch(n=>{a(n)})})}async function fe(){await be().then(e=>{const a=Object.assign({},{invoice:B.formatDataForSave(i.value),invoiceNumberSequence:E.value,invoiceLines:e});x.create("invoices",a,{path:"generate_with_lines"}).then(t=>{i.value.id=t.id,r.value=t.invoiceLines,C.value=2,g("Invoice created successfully!")}).catch(t=>{g("Error creating invoice!"),I.error("Error creating invoice",t)})}).catch(e=>{g("Error formatting invoice for save!"),I.error("Error formatting invoice for save",e)})}const C=o(0),ge=u(()=>[{title:"Filter Work Logs"},{title:"Fill Invoice and Lines"},{title:"Preview Invoice"}]);async function ye(e){e===0&&(S(),C.value=e)}async function Ve(e){e===1&&await ne()}async function Ie(){await fe()}return Te(()=>{le()}),(e,a)=>(_(),Se("div",je,[v(xe,{steps:l(ge),"current-step-number":C.value,onPrevStep:ye,onNextStep:Ve,onSubmit:Ie},{"step-0":c(()=>[v(R,{modelValue:y.value,"onUpdate:modelValue":a[0]||(a[0]=t=>y.value=t),"fields-layout":l(Y),"data-fields":l(Z),schemas:l(T),"error-messages":ee.value,submittable:!1},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages"])]),"step-1":c(()=>[i.value?(_(),F(R,{key:0,modelValue:i.value,"onUpdate:modelValue":a[1]||(a[1]=t=>i.value=t),"fields-layout":z,"data-fields":l(me),schemas:l(w),"error-messages":q.value,submittable:!1},null,8,["modelValue","data-fields","schemas","error-messages"])):D("",!0),f("div",Oe,[i.value?(_(),F(l(we),{key:0,name:"Invoice Lines",headers:A,data:r.value,"table-actions":ie,actions:se,loading:d.value,pagination:{offset:0,limit:r.value.length,client:!0}},{["data-col.description"]:c(({row:t,i:n})=>[f("div",Ae,[v(l(h),{modelValue:t.description,"onUpdate:modelValue":s=>t.description=s,type:"text",label:"",size:"md","error-message":p(n,"description")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),["data-col.unitCost"]:c(({row:t,i:n})=>[f("div",Me,[v(l(h),{modelValue:t.unitCost,"onUpdate:modelValue":s=>t.unitCost=s,type:"number",label:"",size:"sm","error-message":p(n,"unitCost")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),["data-col.unit"]:c(({row:t,i:n})=>[f("div",ze,[v(l(Ee),{modelValue:t.unit,"onUpdate:modelValue":s=>t.unit=s,type:"text",label:"",size:"sm",options:l(re),"error-message":p(n,"unit")},null,8,["modelValue","onUpdate:modelValue","options","error-message"])])]),["data-col.unitValue"]:c(({row:t,i:n})=>[f("div",He,[v(l(h),{modelValue:t.unitValue,"onUpdate:modelValue":s=>t.unitValue=s,type:"number",label:"",size:"sm","error-message":p(n,"unitValue")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),["data-col.subtotal"]:c(({row:t,i:n})=>[f("div",Be,[v(l(h),{modelValue:t.subtotal,"onUpdate:modelValue":s=>t.subtotal=s,type:"number",label:"",size:"sm","error-message":p(n,"subtotal")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),pagination:c(({total:t})=>[Fe(" Total Lines: "+De(t),1)]),_:2},1032,["data","loading","pagination"])):D("",!0)])]),"step-2":c(()=>[b.value?(_(),F(Ne,{key:0,id:b.value.id,"template-type":"invoice_templates","content-markup":b.value.contentMarkup,"content-styles":b.value.contentStyles,data:l(pe),disabled:!0},null,8,["id","content-markup","content-styles","data"])):D("",!0)]),_:1},8,["steps","current-step-number"])]))}},Xe=Ce(Pe,[["__scopeId","data-v-da65e948"]]);export{Xe as default};
